<html>
  <head>
    <title>Message Rate VARZ</title>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"/>
    <script type="text/javascript" src="js/strftime-min.js"></script>
    <script type="text/javascript" src="js/rgbcolor.js"></script>
    <script type="text/javascript" src="js/dygraph-canvas.js"></script>
    <script type="text/javascript" src="js/dygraph.js"></script>
  </head>
  <body>
    <h3 style="width:800px; text-align: center;">Message Rate VARZ</h3>
    <div id="div_g" style="width:800px; height:400px;"></div>

    <script type="text/javascript">
      var data = [];

      // populate at least one data point in the past.
      var t = new Date();
      var x = new Date(t.getTime() - 1 * 1000);
      data.push([x, 0.]);

      // start for tracking the duration
      var start = t.getTime();
      var messageInit = 0;

      var g = new Dygraph(document.getElementById("div_g"), data,
                          {
                            drawPoints: true,
                            showRoller: true,
                            valueRange: [0.0, 5.0],
                            labels: ['Time', 'message_rate']
                          });
      setInterval(function() {

      // Sample the varz here.
      var x = new Date();  // current time
      var duration = x.getTime() - start;

      var varz_json = $.ajax(
      { url: "http://localhost:8080/varz", crossDomain: true,
        async: false, dataType : 'json' }).responseText;

      var varz = $.parseJSON(varz_json);

      if (messageInit == 0) messageInit = varz.messages;

      var y = (varz.messages - messageInit) / duration * 1000.;

      data.push([x, y]);
      g.updateOptions( { 'file': data } );
      }, 5 * 1000); // in seconds

    </script>

    <p>This test is modeled after a <a
      href="http://www.highcharts.com/demo/?example=dynamic-update&theme=default">highcharts
      test</a>. New points should appear once per second. Try zooming and
    panning over to the right edge to watch them show up.</p>
  </body>
</html>
