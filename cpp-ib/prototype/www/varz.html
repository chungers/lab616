<html>
  <head>
    <title>Message Rate VARZ</title>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
    <script type="text/javascript" src="js/strftime-min.js"></script>
    <script type="text/javascript" src="js/rgbcolor.js"></script>
    <script type="text/javascript" src="js/dygraph-canvas.js"></script>
    <script type="text/javascript" src="js/dygraph.js"></script>
    <script type="text/javascript" src="js/varz.js"></script>
  </head>
  <body>

    <div style="width:600px; float:left">
      <h3 style="text-align: center;">Bid/Ask/Mid</h3>
      <div id="div_g" style="width:600px; height:300px"></div>
    </div>
    <div style="width:600px; float:right">
      <h3 style="text-align: center;">Message Rate VARZ</h3>
      <div id="div_g2" style="width:600px; height:300px;"></div>
    </div>
    <script type="text/javascript">
      //console.debug = function() {}; // redefines function to disable logging.
      var sample_seconds = 5;

      var initial = {
        ts : 0,
        messages : 0,
        y1 : 0.,
        y2 : 0.,
        bid : 0.,
        ask : 0.,
        mid : 0.,
      };
      var varzSample = new Varz("http://localhost:8080/varz", initial,
      function(lastVarz, varz) {
        if (lastVarz == initial) {
          return {
            ts: varz.data_ts / 1000,
            messages: varz.messages,
            y1: varz.message_rate,
            y2: 0.,
            bid : 0.,
            ask : 0.,
            mid : 0.,
          };
        } else {
          var ts_millis = varz.data_ts / 1000;
          var d_messages = varz.messages - lastVarz.messages;
          var d_t = (ts_millis - lastVarz.ts) / 1000; // seconds
          var rate = (d_t > 0) ? d_messages / d_t : 0;
          console.debug("d_messages = " + d_messages + ", dt = " + d_t,
                        ", messages = " + varz.messages +
                        ", last = " + lastVarz.messages);

          return {
            ts: ts_millis,
            messages: varz.messages,
            y1: varz.message_rate,
            y2: rate,
            bid : varz.bid / 100,
            ask : varz.ask / 100,
            mid : varz.mid / 100,
          };
        }
      });

      var hasData = varzSample.sample();
      while (!hasData) {
        console.log("No data yet. Waiting.");
        setTimeout(hasData = varzSample.sample(), 1000.);
      }
      var plotData = varzSample.plotData('ts', ['bid', 'mid', 'ask', 'y2']);
      console.debug('VARZ = ' + plotData);

      // from the first time point, compute the offset with
      // the current time:
      var now = new Date();
      var offset = now.getTime() - plotData[0].getTime();

      var data = [];
      var data2 = [];
      var x = plotData[0];
      var bid = plotData[1];
      var mid = plotData[2];
      var ask = plotData[3];
      var rate = plotData[4];

      var p1 = [x, [bid, mid, ask]];
      //var p1 = [x, mid];
      var p2 = [x, rate];
      console.debug("p1 = " + p1 + ", p2 = " + p2);
      data.push(p1);
      data2.push(p2);

      var g = new Dygraph(document.getElementById("div_g"), data,
      {
        drawPoints: false,
        //showRoller: false,
        //rollPeriod: 5,
        //labels: ['Time', 'Price'], //'bid', 'mid', 'ask'],
        customBars: true,
        errorBars: true,
        //logscale: false,
        includeZero: false,
        valueRange: [300.0, 400.],
      });

      // Shows the computed message_rate as sampled by varzSampler.

      var g2 = new Dygraph(document.getElementById("div_g2"), data2,
      {
        drawPoints: false,
        showRoller: true,
        rollPeriod: 12,
        labels: ['Time', 'Message Rate'],
      });

      // Set the interval timer
      setInterval(function() {

      // Sample the varz here.
      var hasData = varzSample.sample();
      if (hasData) {

        var plotData = varzSample.plotData('ts', ['bid', 'mid', 'ask', 'y2']);

        // Use a different time -- the time is based on the
        // the browser client's time, with an offset computed
        // to match the incoming data's original time.  However,
        // we allow this time to continue to advance, even when the
        // server has no data any more.  This is so that we can
        // observe a sharp drop in the data rate -- which will be
        // useful to detect the case when the data feed is down.

        var time = new Date((new Date()).getTime() - offset);

        var x = plotData[0];
        var bid = plotData[1];
        var mid = plotData[2];
        var ask = plotData[3];
        var rate = plotData[4];

        var p1 = [x, [bid, mid, ask]];
        //var p1 = [x, mid];
        var p2 = [x, rate];

        console.debug("p1 = " + p1 + ", p2 = " + p2);

        data.push(p1);
        data2.push(p2);

        g.updateOptions( { file: data } );
        g2.updateOptions( { file: data2 } );

      }

      }, sample_seconds * 1000.);

    </script>
  </body>
</html>
