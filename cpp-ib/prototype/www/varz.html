<html>
  <head>
    <title>Message Rate VARZ</title>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"/>
    <script type="text/javascript" src="js/strftime-min.js"></script>
    <script type="text/javascript" src="js/rgbcolor.js"></script>
    <script type="text/javascript" src="js/dygraph-canvas.js"></script>
    <script type="text/javascript" src="js/dygraph.js"></script>
  </head>
  <body>
    <h3 style="width:800px; text-align: center;">Message Rate VARZ</h3>
    <div id="div_g" style="width:800px; height:400px;"></div>

    <script type="text/javascript">
      var sample_seconds = 5;
      var rollPeriod = 6;
      var data = [];

      // populate at least one data point in the past.
      var last_millis = (new Date()).getTime();
      var last_messages = 0;

      var x0 = new Date(last_millis - sample_seconds * 1000);
      data.push([x0, 0., 0.]);

      var g = new Dygraph(document.getElementById("div_g"), data,
      {
      'drawPoints': true,
      'showRoller': true,
      'rollPeriod': rollPeriod,
      //'valueRange': [0.0, 20.0],
      'labels': ['Time', 'sample_message_rate', 'message_rate']
      });
      setInterval(function() {

      // Sample the varz here.
      var varz_json = $.ajax(
      { url: "http://localhost:8080/varz", crossDomain: true,
        async: false, dataType : 'json' }).responseText;

      var varz = $.parseJSON(varz_json);

      var now_millis = (new Date()).getTime();
      var messages = varz.messages;
      var d_messages = messages - last_messages;
      var dt = (now_millis - last_millis) / 1000.;

      var y1 = d_messages / dt;
      var y2 = varz.message_rate;

      var new_data = [new Date(now_millis), y1, y2];

      console.log("dt = " + dt + ", sample_seconds = " + sample_seconds +
      ", d_messages = " + d_messages + ", messages = " + messages +
      ", y1 = " + y1 + ", y2 = " + y2);

      if (last_messages > 0) {
        // Make sure dt is within 80% of the sample interval.
        data.push(new_data);
        g.updateOptions( { 'file': data } );
      }

      // Update for next sample:
      last_millis = now_millis;
      last_messages = messages;

      }, sample_seconds * 1000.);

    </script>
  </body>
</html>
